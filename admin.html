<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì½”ì¸ ë§¤ì… ì‹ ì²­ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    .dashboard-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 16px 40px 16px;
    }
    h2 {
      text-align: left;
      color: #008080;
      margin-bottom: 24px;
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -1px;
    }
    .summary-cards {
      display: flex;
      gap: 24px;
      margin-bottom: 36px;
      flex-wrap: wrap;
    }
    .card {
      flex: 1 1 180px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
      padding: 28px 20px 20px 28px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 180px;
      min-height: 100px;
      position: relative;
      overflow: hidden;
    }
    .card .icon {
      font-size: 2.2rem;
      margin-bottom: 8px;
      opacity: 0.18;
      position: absolute;
      right: 18px;
      top: 18px;
      pointer-events: none;
    }
    .card-title {
      font-size: 1.1rem;
      color: #008080;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .card-value {
      font-size: 2.1rem;
      font-weight: 900;
      color: #222;
      letter-spacing: -2px;
    }
    .card-value.status-ì‹ ì²­ { color: #00796b; }
    .card-value.status-ì²˜ë¦¬ì¤‘ { color: #fbc02d; }
    .card-value.status-ì™„ë£Œ { color: #388e3c; }
    .card-value.status-ì˜¤ëŠ˜ { color: #1976d2; }
    .table-section {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
      padding: 28px 16px 24px 16px;
    }
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 18px;
    }
    .filter-bar input, .filter-bar select {
      padding: 7px 10px;
      border-radius: 7px;
      border: 1px solid #bbb;
      font-size: 15px;
    }
    .filter-bar label {
      font-size: 15px;
      color: #008080;
      font-weight: 600;
      margin-right: 2px;
    }
    .filter-bar button {
      background: linear-gradient(90deg, #00bfa5, #00897b);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 16px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    .filter-bar button:hover {
      background: linear-gradient(90deg, #00897b, #00bfa5);
      transform: translateY(-2px) scale(1.04);
    }
    .chart-section {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
      padding: 24px 16px 8px 16px;
      margin-bottom: 32px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
      margin-top: 8px;
    }
    th, td {
      padding: 12px 8px;
      border-bottom: 1px solid #eee;
      text-align: center;
      font-size: 1rem;
    }
    th {
      background: #e0f7fa;
      color: #00695c;
      font-weight: 700;
    }
    tr:last-child td {
      border-bottom: none;
    }
    select, button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    button {
      background: linear-gradient(90deg, #00bfa5, #00897b);
      color: #fff;
      border: none;
      cursor: pointer;
      margin-left: 4px;
      transition: background 0.2s, transform 0.2s;
      font-weight: 700;
    }
    button:hover {
      background: linear-gradient(90deg, #00897b, #00bfa5);
      transform: translateY(-2px) scale(1.04);
    }
    .status {
      font-weight: bold;
      font-size: 1.05em;
    }
    .status-ì‹ ì²­ { color: #00796b; }
    .status-ì²˜ë¦¬ì¤‘ { color: #fbc02d; }
    .status-ì™„ë£Œ { color: #388e3c; }
    .delete-btn {
      background: #e57373;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 14px;
      font-weight: 700;
      margin-left: 0;
      margin-right: 0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .delete-btn:hover {
      background: #c62828;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 18px;
    }
    .pagination button {
      background: #e0f7fa;
      color: #008080;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    .pagination button.active {
      background: #00bfa5;
      color: #fff;
    }
    .modal-bg {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.25);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: 14px;
      padding: 32px 24px 24px 24px;
      min-width: 320px;
      max-width: 90vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      position: relative;
    }
    .modal-close {
      position: absolute;
      right: 18px;
      top: 12px;
      font-size: 1.5rem;
      color: #888;
      cursor: pointer;
      font-weight: bold;
    }
    @media (max-width: 900px) {
      .summary-cards { flex-direction: column; gap: 16px; }
      .dashboard-container { padding: 16px 2vw; }
    }
    @media (max-width: 600px) {
      .table-section, .dashboard-container { padding: 4px 0; }
      th, td { font-size: 0.95rem; padding: 7px 2px; }
      .card { min-width: 120px; padding: 18px 8px 12px 16px; }
      h2 { font-size: 1.2rem; }
      .modal { padding: 18px 6px 12px 6px; }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h2>ì½”ì¸ ë§¤ì… ì‹ ì²­ ëŒ€ì‹œë³´ë“œ</h2>
    <div class="summary-cards" id="summary-cards"></div>
    <div class="chart-section">
      <canvas id="statusChart" height="60"></canvas>
      <canvas id="dateChart" height="60" style="margin-top:24px;"></canvas>
    </div>
    <div class="table-section">
      <div class="filter-bar">
        <label>ì…ê¸ˆìëª…</label><input id="filter-depositor" placeholder="ì…ê¸ˆìëª…" />
        <label>ìƒíƒœ</label><select id="filter-status"><option value="">ì „ì²´</option><option>ì‹ ì²­</option><option>ì²˜ë¦¬ì¤‘</option><option>ì™„ë£Œ</option></select>
        <label>ì½”ì¸</label><select id="filter-coin"><option value="">ì „ì²´</option><option>USDT</option><option>BTC</option><option>ETH</option></select>
        <label>ë‚ ì§œ</label><input id="filter-date" type="date" />
        <button id="download-csv">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      </div>
      <div id="table-container">ë¡œë”© ì¤‘...</div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
  <div id="modal-root"></div>
  <script>
    // -------------------- ìƒíƒœ ë³€ìˆ˜ ë° DOM --------------------
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const PAGE_SIZE = 10;
    const filterDepositor = document.getElementById('filter-depositor');
    const filterStatus = document.getElementById('filter-status');
    const filterCoin = document.getElementById('filter-coin');
    const filterDate = document.getElementById('filter-date');

    // -------------------- ë°ì´í„° fetch --------------------
    async function fetchData() {
      const res = await fetch('http://localhost:3000/api/apply');
      return await res.json();
    }

    // -------------------- í•„í„°ë§ --------------------
    function applyFilter() {
      let data = allData;
      if (filterDepositor.value.trim()) {
        data = data.filter(x => x.depositor && x.depositor.includes(filterDepositor.value.trim()));
      }
      if (filterStatus.value) {
        data = data.filter(x => x.status === filterStatus.value);
      }
      if (filterCoin.value) {
        data = data.filter(x => x.coinType === filterCoin.value);
      }
      if (filterDate.value) {
        data = data.filter(x => x.createdAt && x.createdAt.slice(0,10) === filterDate.value);
      }
      filteredData = data;
      currentPage = 1;
      renderTable();
      renderPagination();
      renderCharts();
    }
    [filterDepositor, filterStatus, filterCoin, filterDate].forEach(el => el.addEventListener('input', applyFilter));

    // -------------------- ìš”ì•½ ì¹´ë“œ --------------------
    function getTodayString() {
      const now = new Date();
      return now.toISOString().slice(0, 10);
    }
    function countSummary(data) {
      const today = getTodayString();
      let total = data.length;
      let ì‹ ì²­ = 0, ì²˜ë¦¬ì¤‘ = 0, ì™„ë£Œ = 0, ì˜¤ëŠ˜ = 0;
      data.forEach(item => {
        if (item.status === 'ì‹ ì²­') ì‹ ì²­++;
        if (item.status === 'ì²˜ë¦¬ì¤‘') ì²˜ë¦¬ì¤‘++;
        if (item.status === 'ì™„ë£Œ') ì™„ë£Œ++;
        if (item.createdAt && item.createdAt.slice(0,10) === today) ì˜¤ëŠ˜++;
      });
      return { total, ì‹ ì²­, ì²˜ë¦¬ì¤‘, ì™„ë£Œ, ì˜¤ëŠ˜ };
    }
    function renderSummaryCards(summary) {
      document.getElementById('summary-cards').innerHTML = `
        <div class="card"><span class="icon">ğŸ“‹</span><div class="card-title">ì „ì²´ ì‹ ì²­</div><div class="card-value">${summary.total}</div></div>
        <div class="card"><span class="icon">ğŸŸ¢</span><div class="card-title">ì‹ ì²­</div><div class="card-value status-ì‹ ì²­">${summary.ì‹ ì²­}</div></div>
        <div class="card"><span class="icon">ğŸŸ¡</span><div class="card-title">ì²˜ë¦¬ì¤‘</div><div class="card-value status-ì²˜ë¦¬ì¤‘">${summary.ì²˜ë¦¬ì¤‘}</div></div>
        <div class="card"><span class="icon">âœ…</span><div class="card-title">ì™„ë£Œ</div><div class="card-value status-ì™„ë£Œ">${summary.ì™„ë£Œ}</div></div>
        <div class="card"><span class="icon">ğŸ“…</span><div class="card-title">ì˜¤ëŠ˜ ì‹ ì²­</div><div class="card-value status-ì˜¤ëŠ˜">${summary.ì˜¤ëŠ˜}</div></div>
      `;
    }

    // -------------------- í…Œì´ë¸” ë Œë”ë§ --------------------
    function statusClass(status) {
      return 'status status-' + status;
    }
    function makeRow(entry, idx) {
      return `<tr data-idx="${idx}">
        <td>${entry.depositor}</td>
        <td>${entry.amount}</td>
        <td>${entry.coinType}</td>
        <td>${entry.network}</td>
        <td>${entry.wallet}</td>
        <td>${new Date(entry.createdAt).toLocaleString()}</td>
        <td><span class="${statusClass(entry.status)}">${entry.status}</span></td>
        <td>
          <select class="status-select">
            <option value="ì‹ ì²­" ${entry.status==='ì‹ ì²­'?'selected':''}>ì‹ ì²­</option>
            <option value="ì²˜ë¦¬ì¤‘" ${entry.status==='ì²˜ë¦¬ì¤‘'?'selected':''}>ì²˜ë¦¬ì¤‘</option>
            <option value="ì™„ë£Œ" ${entry.status==='ì™„ë£Œ'?'selected':''}>ì™„ë£Œ</option>
          </select>
          <button class="save-btn">ì €ì¥</button>
          <button class="delete-btn">ì‚­ì œ</button>
        </td>
      </tr>`;
    }
    function renderTable() {
      const data = filteredData;
      if (!data.length) {
        document.getElementById('table-container').innerHTML = '<p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      const start = (currentPage-1)*PAGE_SIZE;
      const end = start+PAGE_SIZE;
      let html = `<table><thead><tr>
        <th>ì…ê¸ˆìëª…</th><th>ê¸ˆì•¡</th><th>ì½”ì¸</th><th>ë„¤íŠ¸ì›Œí¬</th><th>ì§€ê°‘ì£¼ì†Œ</th><th>ì‹ ì²­ì¼ì‹œ</th><th>ìƒíƒœ</th><th>ìƒíƒœë³€ê²½/ì‚­ì œ</th>
      </tr></thead><tbody>`;
      html += data.slice(start, end).map(makeRow).join('');
      html += '</tbody></table>';
      document.getElementById('table-container').innerHTML = html;
    }

    // -------------------- í…Œì´ë¸” ì´ë²¤íŠ¸ ìœ„ì„ --------------------
    document.getElementById('table-container').addEventListener('click', async function(e) {
      const tr = e.target.closest('tr');
      if (!tr) return;
      const idx = tr.getAttribute('data-idx');
      const entry = filteredData[idx];
      // ìƒì„¸ ëª¨ë‹¬ (í–‰ í´ë¦­, ë²„íŠ¼/ì…€ë ‰íŠ¸ ì œì™¸)
      if (e.target.tagName === 'TD') {
        showModal(entry);
      }
      // ìƒíƒœ ì €ì¥
      if (e.target.classList.contains('save-btn')) {
        const select = tr.querySelector('.status-select');
        const status = select.value;
        e.target.disabled = true;
        try {
          const res = await fetch(`http://localhost:3000/api/apply/${entry.id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
          });
          const data = await res.json();
          if (data.success) {
            alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            allData = await fetchData();
            applyFilter();
          } else {
            alert(data.error || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
          }
        } catch {
          alert('ì„œë²„ ì˜¤ë¥˜');
        }
        e.target.disabled = false;
      }
      // ì‚­ì œ
      if (e.target.classList.contains('delete-btn')) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        e.target.disabled = true;
        try {
          const res = await fetch(`http://localhost:3000/api/apply/${entry.id}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            allData = await fetchData();
            applyFilter();
          } else {
            alert(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
          }
        } catch {
          alert('ì„œë²„ ì˜¤ë¥˜');
        }
        e.target.disabled = false;
      }
    });
    // ìƒì„¸ ëª¨ë‹¬ (í–‰ í´ë¦­)
    document.getElementById('table-container').addEventListener('dblclick', function(e) {
      const tr = e.target.closest('tr');
      if (!tr) return;
      const idx = tr.getAttribute('data-idx');
      showModal(filteredData[idx]);
    });

    // -------------------- í˜ì´ì§€ë„¤ì´ì…˜ --------------------
    function renderPagination() {
      const total = filteredData.length;
      const pageCount = Math.ceil(total/PAGE_SIZE);
      let html = '';
      for (let i=1; i<=pageCount; i++) {
        html += `<button class="${i===currentPage?'active':''}" data-page="${i}">${i}</button>`;
      }
      document.getElementById('pagination').innerHTML = html;
    }
    document.getElementById('pagination').addEventListener('click', function(e) {
      if (e.target.tagName === 'BUTTON') {
        currentPage = parseInt(e.target.getAttribute('data-page'));
        renderTable();
        renderPagination();
      }
    });

    // -------------------- ìƒì„¸ ëª¨ë‹¬ --------------------
    function showModal(entry) {
      const root = document.getElementById('modal-root');
      root.innerHTML = `<div class="modal-bg" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
          <span class="modal-close" onclick="closeModal(event)">&times;</span>
          <h3 style="color:#008080; margin-bottom:18px;">ì‹ ì²­ ìƒì„¸ ì •ë³´</h3>
          <div style="line-height:2;">
            <b>ì…ê¸ˆìëª…:</b> ${entry.depositor}<br>
            <b>ì…ê¸ˆ ê¸ˆì•¡:</b> ${parseFloat(entry.amount).toLocaleString()} KRW<br>
            <b>ì½”ì¸ ì¢…ë¥˜:</b> ${entry.coinType}<br>
            <b>ë„¤íŠ¸ì›Œí¬:</b> ${entry.network}<br>
            <b>ì§€ê°‘ ì£¼ì†Œ:</b> ${entry.wallet}<br>
            <b>ì‹ ì²­ì¼ì‹œ:</b> ${new Date(entry.createdAt).toLocaleString()}<br>
            <b>ìƒíƒœ:</b> <span class="${statusClass(entry.status)}">${entry.status}</span>
          </div>
        </div>
      </div>`;
    }
    window.closeModal = function(e) {
      if (e) e.stopPropagation();
      document.getElementById('modal-root').innerHTML = '';
    }

    // -------------------- CSV ë‹¤ìš´ë¡œë“œ --------------------
    document.getElementById('download-csv').addEventListener('click', function() {
      let csv = 'ì…ê¸ˆìëª…,ê¸ˆì•¡,ì½”ì¸,ë„¤íŠ¸ì›Œí¬,ì§€ê°‘ì£¼ì†Œ,ì‹ ì²­ì¼ì‹œ,ìƒíƒœ\n';
      filteredData.forEach(entry => {
        csv += `${entry.depositor},${entry.amount},${entry.coinType},${entry.network},${entry.wallet},${new Date(entry.createdAt).toLocaleString()},${entry.status}\n`;
      });
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'coin_apply_list.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // -------------------- Chart.js ê·¸ë˜í”„ --------------------
    let statusChart, dateChart;
    function renderCharts() {
      // ìƒíƒœë³„
      const statusCount = { 'ì‹ ì²­':0, 'ì²˜ë¦¬ì¤‘':0, 'ì™„ë£Œ':0 };
      filteredData.forEach(x => { if (statusCount[x.status] !== undefined) statusCount[x.status]++; });
      const ctx1 = document.getElementById('statusChart').getContext('2d');
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: ['ì‹ ì²­', 'ì²˜ë¦¬ì¤‘', 'ì™„ë£Œ'],
          datasets: [{
            label: 'ìƒíƒœë³„ ì‹ ì²­ ê±´ìˆ˜',
            data: [statusCount['ì‹ ì²­'], statusCount['ì²˜ë¦¬ì¤‘'], statusCount['ì™„ë£Œ']],
            backgroundColor: ['#00796b','#fbc02d','#388e3c']
          }]
        },
        options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
      // ì¼ë³„
      const dateMap = {};
      filteredData.forEach(x => {
        const d = x.createdAt ? x.createdAt.slice(0,10) : 'ê¸°íƒ€';
        dateMap[d] = (dateMap[d]||0)+1;
      });
      const dateLabels = Object.keys(dateMap).sort();
      const dateVals = dateLabels.map(d=>dateMap[d]);
      const ctx2 = document.getElementById('dateChart').getContext('2d');
      if (dateChart) dateChart.destroy();
      dateChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: dateLabels,
          datasets: [{
            label: 'ì¼ë³„ ì‹ ì²­ ê±´ìˆ˜',
            data: dateVals,
            backgroundColor: '#1976d2'
          }]
        },
        options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // -------------------- ë°ì´í„° ìµœì´ˆ ë¡œë“œ --------------------
    async function init() {
      allData = await fetchData();
      filteredData = allData;
      renderSummaryCards(countSummary(allData));
      applyFilter();
    }
    init();
  </script>
</body>
</html> 